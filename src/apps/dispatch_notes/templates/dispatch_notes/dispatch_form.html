{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Nota de Despacho</h2>
    <form method="post" id="dispatch-form">
        {% csrf_token %}
        
        <div class="card mb-4">
            <div class="card-header">Información General</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">{{ form.dispatch_number|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.client|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.beneficiary|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.supplier|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.order_number|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-12">{{ form.notes|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Información del Conductor y Vehículo</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">{{ form.driver_name|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.driver_id|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-4">{{ form.vehicle_type|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.vehicle_color|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.license_plate|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Productos</div>
            <div class="card-body">
                {{ formset.management_form }}
                <div id="formset-container">
                    {% for item_form in formset %}
                    <div class="formset-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn-close remove-item" aria-label="Cerrar"></button>
                        </div>
                        
                        <!-- Campos ocultos necesarios -->
                        {{ item_form.id }}
                        {{ item_form.DELETE|default:"" }}
                        
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ item_form.product_search.id_for_label }}" class="form-label">
                                        {{ item_form.product_search.label }}
                                    </label>
                                    {{ item_form.product_search }}
                                    <small class="form-text text-muted">Buscar por código</small>
                                    {% if item_form.product_search.errors %}
                                    <div class="text-danger">{{ item_form.product_search.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ item_form.product_description.id_for_label }}" class="form-label">
                                        {{ item_form.product_description.label }}
                                    </label>
                                    {{ item_form.product_description }}
                                    <small class="form-text text-muted">Descripción del producto</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="{{ item_form.quantity.id_for_label }}" class="form-label">
                                        {{ item_form.quantity.label }}
                                    </label>
                                    {{ item_form.quantity }}
                                    {% if item_form.quantity.errors %}
                                    <div class="text-danger">{{ item_form.quantity.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="{{ item_form.unit_price.id_for_label }}" class="form-label">
                                        {{ item_form.unit_price.label }}
                                    </label>
                                    {{ item_form.unit_price }}
                                    {% if item_form.unit_price.errors %}
                                    <div class="text-danger">{{ item_form.unit_price.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    {{ item_form.product }}
                                    {% if item_form.product.errors %}
                                    <div class="text-danger">{{ item_form.product.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 align-items-end mt-2">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ item_form.brand.id_for_label }}" class="form-label">
                                        {{ item_form.brand.label }}
                                    </label>
                                    {{ item_form.brand }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ item_form.model.id_for_label }}" class="form-label">
                                        {{ item_form.model.label }}
                                    </label>
                                    {{ item_form.model }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary mt-3" id="add-item">Añadir Otro Producto</button>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Guardar Nota de Despacho</button>
            <button type="button" id="debug-form-btn" class="btn btn-warning">Debug Form State</button>
            <button type="button" id="debug-btn" class="btn btn-info">Debug Info</button>
            <a href="{% url 'dispatch_notes:list' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<template id="empty-form-template">
    <div class="formset-item mb-3 p-3 border rounded">
        <div class="d-flex justify-content-end">
            <button type="button" class="btn-close remove-item" aria-label="Cerrar"></button>
        </div>
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="__prefix__-product_search" class="form-label">Código Producto</label>
                    <input type="text" name="__prefix__-product_search" class="form-control product-search" placeholder="Buscar por código..." id="__prefix__-product_search">
                    <small class="form-text text-muted">Buscar por código</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="__prefix__-product_description" class="form-label">Descripción</label>
                    <input type="text" name="__prefix__-product_description" class="form-control" placeholder="Descripción del producto..." readonly id="__prefix__-product_description">
                    <small class="form-text text-muted">Descripción del producto</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label for="__prefix__-quantity" class="form-label">Cantidad</label>
                    <input type="number" name="__prefix__-quantity" class="form-control" min="1" value="1" id="__prefix__-quantity">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label for="__prefix__-unit_price" class="form-label">Precio Unitario</label>
                    <input type="number" name="__prefix__-unit_price" class="form-control" step="0.01" id="__prefix__-unit_price">
                </div>
            </div>
            <div class="col-md-2">
                <input type="hidden" name="__prefix__-product" id="__prefix__-product">
            </div>
        </div>
        <div class="row g-3 align-items-end mt-2">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="__prefix__-brand" class="form-label">Marca</label>
                    <input type="text" name="__prefix__-brand" class="form-control" id="__prefix__-brand">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="__prefix__-model" class="form-label">Modelo</label>
                    <input type="text" name="__prefix__-model" class="form-control" id="__prefix__-model">
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addItemButton = document.getElementById('add-item');
        const formsetContainer = document.getElementById('formset-container');
        const totalForms = document.querySelector('input[name$="TOTAL_FORMS"]');
        const emptyFormTemplate = document.getElementById('empty-form-template');

        // Función para agregar nuevo item
        addItemButton.addEventListener('click', () => {
            const currentTotalForms = parseInt(totalForms.value);
            const newForm = emptyFormTemplate.innerHTML.replace(/__prefix__/g, currentTotalForms);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newForm.trim();
            const newFormElement = tempDiv.firstChild;
            formsetContainer.appendChild(newFormElement);

            totalForms.value = currentTotalForms + 1;
            
            // Inicializar la búsqueda para el nuevo campo
            initProductSearch(newFormElement);
        });

        // Función para eliminar item - CORREGIDA
        formsetContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-item')) {
                const formToRemove = e.target.closest('.formset-item');
                if (formToRemove) {
                    // Buscar el checkbox DELETE si existe (para forms existentes)
                    const deleteCheckbox = formToRemove.querySelector('input[name*="-DELETE"]');
                    if (deleteCheckbox) {
                        // Form existente: marcar el checkbox y ocultar
                        deleteCheckbox.checked = true;
                        formToRemove.style.display = 'none';
                        console.log('Marked existing form for deletion');
                    } else {
                        // Form nuevo: eliminar directamente
                        formToRemove.remove();
                        const currentTotalForms = parseInt(totalForms.value);
                        totalForms.value = currentTotalForms - 1;
                        console.log('Removed new form');
                        
                        // Reindexar los forms restantes
                        const forms = formsetContainer.querySelectorAll('.formset-item');
                        forms.forEach((form, index) => {
                            form.querySelectorAll('[name]').forEach(input => {
                                const newName = input.name.replace(/-\d+-/g, `-${index}-`);
                                input.name = newName;
                                const newId = input.id.replace(/-\d+-/g, `-${index}-`);
                                input.id = newId;
                            });
                        });
                    }
                }
            }
        });

        // Función para inicializar la búsqueda de productos
        function initProductSearch(container) {
            const searchInput = container ? container.querySelector('.product-search') : document.querySelector('.product-search');
            if (!searchInput) return;
            
            let timeout = null;
            const resultsContainer = document.createElement('div');
            resultsContainer.classList.add('product-results', 'list-group', 'mt-1');
            searchInput.parentNode.appendChild(resultsContainer);

            searchInput.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    const query = searchInput.value.trim();
                    resultsContainer.innerHTML = '';
                    
                    if (query.length > 1) {
                        fetch(`{% url 'dispatch_notes:product_search_api' %}?q=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                resultsContainer.innerHTML = '';
                                
                                if (data && data.length > 0) {
                                    data.forEach(product => {
                                        const item = document.createElement('a');
                                        item.href = '#';
                                        item.classList.add('list-group-item', 'list-group-item-action');
                                        
                                        // Mostrar información completa
                                        item.innerHTML = `
                                            <div class="fw-bold">${product.product_code}</div>
                                            <div class="small">${product.description}</div>
                                            ${product.unit_price ? `<div class="text-success">Precio: $${product.unit_price}</div>` : ''}
                                            ${product.current_stock !== undefined ? `<div class="text-info">Stock: ${product.current_stock}</div>` : ''}
                                        `;
                                        
                                        item.addEventListener('click', (e) => {
                                            e.preventDefault();
                                            autocompleteProductFields(searchInput, product);
                                            resultsContainer.innerHTML = '';
                                        });
                                        resultsContainer.appendChild(item);
                                    });
                                } else {
                                    const noResults = document.createElement('div');
                                    noResults.classList.add('list-group-item', 'text-muted');
                                    noResults.textContent = 'No se encontraron productos';
                                    resultsContainer.appendChild(noResults);
                                }
                            })
                            .catch(error => {
                                console.error('Error en búsqueda:', error);
                                resultsContainer.innerHTML = '';
                            });
                    }
                }, 300);
            });

            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.innerHTML = '';
                }
            });
        }

        // Función para autocompletar campos - COMPLETAMENTE CORREGIDA
        function autocompleteProductFields(searchInput, product) {
            const formsetItem = searchInput.closest('.formset-item');
            
            console.log('=== AUTCOMPLETE DEBUG START ===');
            console.log('Product object:', product);
            
            // 1. Llenar el campo de búsqueda con el código
            if (searchInput) {
                searchInput.value = product.product_code || '';
                console.log('Search input set to:', searchInput.value);
            }
            
            // 2. Llenar el campo de descripción
            const descriptionInput = formsetItem.querySelector('input[name*="-product_description"]');
            if (descriptionInput && product.description) {
                descriptionInput.value = product.description;
                console.log('Description input set to:', descriptionInput.value);
            }
            
            // 3. CORRECCIÓN PRINCIPAL: Encontrar el campo hidden del producto
            let productIdInput = null;
            
            // Intentar diferentes selectores para encontrar el campo
            const selectors = [
                'input[name$="-product"]',
                'input[type="hidden"][name*="product"]',
                'input[name*="product"][type="hidden"]'
            ];
            
            for (const selector of selectors) {
                productIdInput = formsetItem.querySelector(selector);
                if (productIdInput && !productIdInput.name.includes('search') && !productIdInput.name.includes('description')) {
                    console.log('Found product field with selector:', selector);
                    break;
                }
            }
            
            // Si aún no se encuentra, buscar manualmente
            if (!productIdInput) {
                console.log('Searching manually for product field...');
                const allInputs = formsetItem.querySelectorAll('input[type="hidden"]');
                for (const input of allInputs) {
                    if (input.name.includes('product') && !input.name.includes('search') && !input.name.includes('description')) {
                        productIdInput = input;
                        console.log('Found product field manually:', input.name);
                        break;
                    }
                }
            }
            
            if (productIdInput && product.id) {
                productIdInput.value = product.id;
                console.log('✅ SUCCESS: Product ID input set to:', productIdInput.value);
                console.log('Product field name:', productIdInput.name);
                
                // Disparar eventos para activar validación
                const changeEvent = new Event('change', { bubbles: true });
                const inputEvent = new Event('input', { bubbles: true });
                productIdInput.dispatchEvent(changeEvent);
                productIdInput.dispatchEvent(inputEvent);
            } else {
                console.error('❌ ERROR: Could not find product field or product has no ID');
                console.log('ProductIdInput:', productIdInput);
                console.log('Product ID:', product.id);
                
                // Debug detallado: mostrar todos los inputs en el form
                const allInputs = formsetItem.querySelectorAll('input');
                console.log('All inputs in form:');
                allInputs.forEach(input => {
                    console.log(`  ${input.name} = ${input.value} (type: ${input.type})`);
                });
            }
            
            // 4. Autocompletar precio unitario
            const unitPriceInput = formsetItem.querySelector('input[name*="-unit_price"]');
            const quantityInput = formsetItem.querySelector('input[name*="-quantity"]');
            
            if (unitPriceInput && product.unit_price) {
                unitPriceInput.value = product.unit_price;
                console.log('Unit price set to:', unitPriceInput.value);
            }
            
            if (quantityInput && !quantityInput.value) {
                quantityInput.value = 1;
                console.log('Quantity set to:', quantityInput.value);
            }
            
            console.log('=== AUTCOMPLETE DEBUG END ===');
        }

        // Función para cargar valores iniciales
        function loadInitialProductValues() {
            document.querySelectorAll('input[name*="-product"][type="hidden"]').forEach(hiddenInput => {
                if (hiddenInput.value && hiddenInput.value.trim() !== '' && 
                    !hiddenInput.name.includes('search') && !hiddenInput.name.includes('description')) {
                    
                    const formsetItem = hiddenInput.closest('.formset-item');
                    const searchInput = formsetItem.querySelector('.product-search');
                    const descriptionInput = formsetItem.querySelector('input[name*="-product_description"]');
                    
                    console.log(`Loading product ID: ${hiddenInput.value} for field: ${hiddenInput.name}`);
                    
                    // Solo hacer la llamada si el valor es numérico
                    if (/^\d+$/.test(hiddenInput.value.trim())) {
                        fetch(`{% url 'dispatch_notes:product_search_api' %}?id=${hiddenInput.value.trim()}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(products => {
                                if (products && products.length > 0) {
                                    const product = products[0];
                                    console.log('Product found:', product);
                                    
                                    if (searchInput) searchInput.value = product.product_code || '';
                                    if (descriptionInput) descriptionInput.value = product.description || '';
                                    
                                    const unitPriceInput = formsetItem.querySelector('input[name*="-unit_price"]');
                                    if (unitPriceInput && product.unit_price) {
                                        unitPriceInput.value = product.unit_price;
                                    }
                                } else {
                                    console.warn('No product found for ID:', hiddenInput.value);
                                    if (searchInput) {
                                        searchInput.value = hiddenInput.value;
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error loading product:', error);
                                if (searchInput) {
                                    searchInput.value = hiddenInput.value;
                                }
                            });
                    } else {
                        if (searchInput) {
                            searchInput.value = hiddenInput.value;
                        }
                    }
                }
            });
        }

        // Botón de debug para testing
        document.getElementById('debug-btn').addEventListener('click', function() {
            console.log('=== DEBUG INFO ===');
            console.log('Total forms:', document.querySelector('input[name$="TOTAL_FORMS"]').value);
            
            document.querySelectorAll('input[name*="-product"]').forEach((input, index) => {
                console.log(`Product ${index}:`, input.value);
                console.log(`Field name:`, input.name);
            });
            
            document.querySelectorAll('.product-search').forEach((input, index) => {
                console.log(`Search ${index}:`, input.value);
            });
        });

        // Botón para ver el estado del formulario
        document.getElementById('debug-form-btn').addEventListener('click', function() {
            console.log('=== FORM STATE DEBUG ===');
            
            // Mostrar todos los campos de producto
            const productInputs = document.querySelectorAll('input[name*="-product"][type="hidden"]');
            console.log('Product inputs found:', productInputs.length);
            
            productInputs.forEach((input, index) => {
                if (!input.name.includes('search') && !input.name.includes('description')) {
                    console.log(`Product ${index + 1}:`);
                    console.log('  Name:', input.name);
                    console.log('  Value:', input.value);
                    console.log('  ID:', input.id);
                    
                    const formsetItem = input.closest('.formset-item');
                    const searchInput = formsetItem.querySelector('.product-search');
                    const descInput = formsetItem.querySelector('input[name*="-product_description"]');
                    
                    console.log('  Search value:', searchInput ? searchInput.value : 'N/A');
                    console.log('  Description value:', descInput ? descInput.value : 'N/A');
                }
            });
        });

        // Validación del formulario al enviar
        document.getElementById('dispatch-form').addEventListener('submit', function(e) {
            console.log("=== FORM SUBMIT VALIDATION ===");
            
            let isValid = true;
            const emptyFields = [];
            
            // Verificar todos los campos de producto hidden
            document.querySelectorAll('input[name*="-product"][type="hidden"]').forEach((input, index) => {
                if (!input.name.includes('search') && !input.name.includes('description')) {
                    const formsetItem = input.closest('.formset-item');
                    
                    // Saltar forms marcados para eliminación
                    const deleteInput = formsetItem.querySelector('input[name*="-DELETE"]');
                    if (deleteInput && deleteInput.checked) {
                        console.log(`Skipping deleted form ${index}`);
                        return;
                    }
                    
                    if (!input.value || input.value.trim() === '') {
                        console.error(`EMPTY PRODUCT FIELD: ${input.name}`);
                        isValid = false;
                        emptyFields.push(`Producto ${index + 1}`);
                        
                        // Resaltar en rojo
                        const searchInput = formsetItem.querySelector('.product-search');
                        if (searchInput) {
                            searchInput.style.borderColor = 'red';
                            searchInput.style.boxShadow = '0 0 5px red';
                        }
                    } else {
                        console.log(`✅ VALID PRODUCT FIELD: ${input.name} = ${input.value}`);
                    }
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                const errorMsg = `Por favor, complete la selección de productos para: ${emptyFields.join(', ')}`;
                alert(errorMsg);
                console.error('Form submission blocked:', errorMsg);
            } else {
                console.log('✅ Form validation passed - submitting...');
            }
        });

        // Inicializar búsqueda para todos los campos existentes
        document.querySelectorAll('.product-search').forEach(input => {
            initProductSearch();
        });

        // Observer para nuevos campos
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.classList.contains('formset-item')) {
                        setTimeout(() => {
                            initProductSearch(node);
                        }, 100);
                    }
                });
            });
        });

        observer.observe(formsetContainer, { childList: true });

        // Cargar valores iniciales cuando la página esté lista
        setTimeout(loadInitialProductValues, 500);
    });
        // Debug temporal del formset
    console.log("=== FORMSET DEBUG ===");
    console.log("Total forms:", "{{ formset.total_form_count }}");
    console.log("Initial forms:", "{{ formset.initial_form_count }}");
    
    {% for form in formset %}
    console.log("Form {{ forloop.counter0 }}:");
    console.log("  Product:", "{{ form.product.value|default:'Empty' }}");
    console.log("  Product search:", "{{ form.product_search.value|default:'Empty' }}");
    {% endfor %}
    
</script>

<style>
    .form-group {
        margin-bottom: 0;
    }
    
    .form-label {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
        color: #495057;
    }
    
    .form-text {
        font-size: 0.75rem;
        margin-top: 0.2rem;
        color: #6c757d;
    }
    
    .form-control {
        font-size: 0.9rem;
        padding: 0.4rem 0.75rem;
        height: calc(2.25rem + 2px);
    }
    
    .form-control[readonly] {
        background-color: #f8f9fa;
        cursor: not-allowed;
        opacity: 0.8;
    }
    
    .align-items-end {
        align-items: end !important;
    }
    
    .mt-2 {
        margin-top: 0.5rem !important;
    }
    
    .product-search {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px 16px;
        padding-right: 35px;
    }
    
    .product-results {
        position: absolute;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .product-results .list-group-item {
        cursor: pointer;
        border: none;
        border-bottom: 1px solid #eee;
        padding: 10px 12px;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .product-results .list-group-item:hover {
        background-color: #e9ecef;
    }
    
    .product-results .list-group-item:last-child {
        border-bottom: none;
    }
    
    .product-results .fw-bold {
        font-size: 15px;
        color: #0d6efd;
    }
    
    .product-results .small {
        font-size: 13px;
        color: #6c757d;
    }
    
    .product-results .text-success {
        font-size: 13px;
        font-weight: 500;
        color: #198754;
    }
    
    .product-results .text-info {
        font-size: 13px;
        color: #0dcaf0;
    }
    
    .formset-item {
        position: relative;
    }
    
    .btn-close {
        padding: 0.5rem;
        margin: -0.5rem -0.5rem -0.5rem auto;
    }
</style>
{% endblock %}